<!DOCTYPE html>
<html>

	<head>
		<title>obj test </title>
		<script type="text/javascript" src="jquery-1.12.4.js"></script>
		<script type="text/javascript" src="libs/three.js"></script>
		<script type="text/javascript" src="libs/OBJLoader.js"></script>
		<script type="text/javascript" src="libs/MTLLoader.js"></script>
		<script type="text/javascript" src="libs/OBJMTLLoader.js"></script>
		<script type="text/javascript" src="libs/TGALoader.js"></script>
		<script type="text/javascript" src="libs/TrackballControls.js"></script>
		<!--<script src="dat.gui.js"></script>-->
		<!--<script type="text/javascript" src="assets/fonts/helvetiker_regular.typeface.js"></script>
		<script type="text/javascript" src="assets/fonts/helvetiker_bold.typeface.js"></script>
		<script type="text/javascript" src="assets/fonts/bitstream_vera_sans_mono_roman.typeface.js"></script>-->
		<style>
			body {
				/* set margin to 0 and overflow to hidden, to go fullscreen */
				margin: 0;
				overflow: hidden;
			}
			
			.text {
				position: absolute;
				right: 10px;
				top: 50px;
				background: #fff;
				z-index: 11111111;
				padding: 20px;
    			border-radius: 5px;
			}
			
			input {
				width: 50px;
				margin-top:10px;
				margin-right:1px;
				 border: none;
   				 border: 1px solid #ccc;
			}
			.wrapper{
				width:100%;
				height:100%;
				background: rgba(0,0,0,.5);
				position:fixed;
				left:0;
				top:0;
				display: none;
			}
			.box{
				width:300px;
				height:100px;
				background: #fff;
				border-radius:20px;
				position: absolute;
				left:50%;
				margin-left:-150px;
				margin-top:-50px;
				top:50%;
				text-align: center;
			}
			.title{
				padding-top: 20px;
    			font-size: 16px;
			}
			.btn{
				outline: none;
			    background: #FF4C5F;
			    color: #fff;
			    border: none;
			    width: 60px;
			    height: 25px;
			    border-radius: 5px;
			    margin-top:15px;
			    cursor: pointer;
			}
			.positioning{
				background: #00AB29;
			}
			.exit{
				background: #FF7F00;
			}
			.detail{
				width:100px;
			}
		</style>
	</head>

	<body>
		<div style="width:100%">
			<div id="WebGL-output" style="width:80%;height:80%">
			</div>
			<div class="text" id="text">
				<button class="detail btn">详情模式</button>
				<div>平面index&nbsp;&nbsp;<input type="text" id="indexId" /></div>
				<div>平面顶点index&nbsp;&nbsp;<input type="text" /></div>
				<div>平面顶点坐标A&nbsp;&nbsp;<input type="text" id="textAx" /><input type="text" id="textAy" /><input type="text" id="textAz" /></div>
				<div>平面顶点坐标B&nbsp;&nbsp;<input type="text" id="textBx" /><input type="text" id="textBy" /><input type="text" id="textBz" /></div>
				<div>平面顶点坐标C&nbsp;&nbsp;<input type="text" id="textCx" /><input type="text" id="textCy" /><input type="text" id="textCz" /></div>
				<button class="highlight btn">高亮</button>
				<button class="positioning btn">定位</button>
				<button class="exit btn">退出</button>
			</div>
			<div class="wrapper">
				<div class="box">
					<div class="title">您没有填入index</div>
					<button class="btn">确定</button>
				</div>
			</div>
		</div>
		<!-- Javascript code that runs our Three.js examples -->
		<script type="text/javascript">
			$('.exit').click(function() {
				window.history.back(-1);
			})
			$('.btn').click(function(){
				$('.wrapper').toggle()
			})
			var mesh;
//			var sphere;
			var geoms = [];
			var textMesh;
			var webGLRenderer;
			function initThree() {
				webGLRenderer = new THREE.WebGLRenderer();
				webGLRenderer.setSize(window.innerWidth, window.innerHeight);
				webGLRenderer.setClearColor(new THREE.Color(0x008080, 1.0));
				document.getElementById("WebGL-output").appendChild(webGLRenderer.domElement);
			}
			var camera;
			function initCamera() {
				camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
				camera.position.x = 30;
				camera.position.y = 100;
				camera.position.z = -100;
				camera.lookAt(scene.position);
			}
			/* 控制器 */
			var trackballControls;
			function initControls() {
				trackballControls = new THREE.TrackballControls(camera,webGLRenderer.domElement);
				trackballControls.rotateSpeed = 0.5; //旋转速度
				trackballControls.zoomSpeed = 0.5; // 缩放速度
				trackballControls.panSpeed = 0.5; // 平controls
				trackballControls.staticMoving = true; // 静止移动，为 true 则没有惯性
			}
			var spotLight;
			function initLight() {
				spotLight = new THREE.DirectionalLight(0xC0C0C0);
				spotLight.position.set(10, 10, -50);
				spotLight.intensity = 3;
				scene.add(spotLight);
			}
			let geometryArr = []
			function initObject() {
				var material = new THREE.PointCloudMaterial({
					size: 4,
					vertexColors: false,
					color: 0xff00ff
				});
				var index = 0;
				var indexX;
				var indexY;
				var indexZ;
				var loader = new THREE.OBJMTLLoader();
				var materialSprite = new THREE.SpriteMaterial();
				loader.load('meinumo.obj', 'meinumo.mtl', function(loadedMesh) {
					var materialSprite = new THREE.SpriteMaterial();
					var material = new THREE.MeshPhongMaterial({
						color: 0x664324,
						wireframe: false,
					})
					loadedMesh.children.forEach(function(child) {
						child.material = material;
						var color = new THREE.Color(0x444444);
						var faces = child.geometry.faces;
						faces.forEach(function(face) {
							let v1 = child.geometry.vertices[face.a];
							let v2 = child.geometry.vertices[face.b];
							let v3 = child.geometry.vertices[face.c];
							let material = new THREE.MeshPhongMaterial({
								color: 0x008000, //3D线条颜色
								wireframe: true,
							});
							let faceGeometry = new THREE.Geometry();
							faceGeometry.vertices.push(new THREE.Vector3(v1.x, v1.y, v1.z));
							faceGeometry.vertices.push(new THREE.Vector3(v2.x, v2.y, v2.z));
							faceGeometry.vertices.push(new THREE.Vector3(v3.x, v3.y, v3.z));
							let face3 = new THREE.Face3(0, 1, 2, face.normal, 0x808080, 0);
							faceGeometry.faces.push(face3);
							faceGeometry.computeFaceNormals();
							faceGeometry.computeVertexNormals();
							let faceMesh = new THREE.Mesh(faceGeometry, material);
							geometryArr.push(faceMesh)
							faceMesh.position.y = -20;
							scene.add(faceMesh);
						});
					});
					mesh = loadedMesh;
					mesh.scale.set(1, 1, 1);
					mesh.position.set(-30, -30, -30);
					var material = new THREE.PointCloudMaterial({
						size: 1,
						vertexColors: true,
						color: 0xffffff
					});
				});
				var meshMaterial = new THREE.MeshPhongMaterial({
					specular: 0xffffff,
					color: 0x000000,
					shininess: 10,
					metal: true
				});
				function createMesh(geom) {
					var meshMaterial = new THREE.MeshPhongMaterial({
						specular: 0xffffff,
						color: 0xeeffff,
						shininess: 100,
						metal: true
					});
					var plane = THREE.SceneUtils.createMultiMaterialObject(geom, [meshMaterial]);
					return plane;
				}
			}

			var vector;

			function onDocumentMouseDown(event) {
				//新建一个三维单位向量 假设z方向就是0.5
				//根据照相机，把这个向量转换到视点坐标系
				//这里定义深度值为0.5，深度值越大，意味着精度越高
				vector = new THREE.Vector3((event.clientX / window.innerWidth) * 2 - 1, -(event.clientY / window.innerHeight) * 2 + 1, 0.5).unproject(camera);
				console.log(event.clientX)
				console.log(event.clientY)
				// 在视点坐标系中形成射线,射线的起点向量是照相机， 射线的方向向量是照相机到点击的点，这个向量应该归一标准化。
				var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());
				var intersects = raycaster.intersectObjects(scene.children);
				if(intersects.length > 0) {
					var selected = intersects[0]; //取第一个物体
					let materialSelected = new THREE.MeshPhongMaterial({
						color: 0xFF0000,
						wireframe: false,
					});
					intersects[0].object.material = materialSelected;
					console.log(intersects[0])
					for(var i=0;i<geometryArr.length;i++){
						if(intersects[0].object.material.uuid == geometryArr[i].material.uuid){
							$('#indexId').val(i)
							console.log(i)
						}
					}
					var vertices = intersects[0].object.geometry.vertices;
					scene.remove(textMesh);
					var posAx = vertices[0].x
					var posAy = vertices[0].y
					var posAz = vertices[0].z

					var posBx = vertices[1].x
					var posBy = vertices[1].y
					var posBz = vertices[1].z

					var posCx = vertices[2].x
					var posCy = vertices[2].y
					var posCz = vertices[2].z
					$('#textAx').val(posAx)
					$('#textAy').val(posAy)
					$('#textAz').val(posAz)
					$('#textBx').val(posBx)
					$('#textBy').val(posBy)
					$('#textBz').val(posBz)
					$('#textCx').val(posCx)
					$('#textCy').val(posCy)
					$('#textCz').val(posCz)
				}
				$(event.target).focus()
			}
			function onTextDocumentMouseDown(event) {
				$(event.target).focus()
			}
			var scene;
			var clock;
			function initScene() {
				clock = new THREE.Clock();
				scene = new THREE.Scene();
			}
			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				webGLRenderer.setSize(window.innerWidth, window.innerHeight);
				render();
			}
			function init() {
				initThree();
				initScene();
				initCamera();
				initLight();
				initObject();
				initControls();
				window.addEventListener("resize", onWindowResize, false);
				trackballControls.addEventListener('change', function() {
					console.log("相机动了！");
				});
				render();
			}
			function render() {
				var delta = clock.getDelta();
				trackballControls.update(delta);
				webGLRenderer.clear();
				requestAnimationFrame(render);
				webGLRenderer.render(scene, camera);
			}
			var factor = 50 //每次放大的倍数
			$('.positioning').click(function() {
				vector.sub(camera.position).normalize();
				console.log(vector)
				camera.position.x += vector.x * factor;
				camera.position.y += vector.y * factor;
				camera.position.z += vector.z * factor;
				trackballControls.target.x += vector.x * factor;
				trackballControls.target.y += vector.y * factor;
				trackballControls.target.z += vector.z * factor;
			})
			$('.highlight').click(function() {
				let materialSelected = new THREE.MeshPhongMaterial({
					color: 0xFF0000,
					wireframe: false,
				});
				let index = parseFloat($('#indexId').val())
				if(!index){
					$('.wrapper').show()
				}else{
					geometryArr[index].material = materialSelected
				}
			})
			$('#WebGL-output').click(function(event){
				console.log('hhhhhhhhh')
				onDocumentMouseDown(event)
			});
			document.getElementById('text').addEventListener('mousedown', onTextDocumentMouseDown);
			/* 初始加载 */
			(function() {
				init();
			})();
		</script>
	</body>

</html>